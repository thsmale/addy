#include "addy.h"

int main() {
	struct addrinfo host_config;
	memset(&host_config, 0, sizeof(struct addrinfo));
	host_config.ai_family = PF_UNSPEC;
	host_config.ai_socktype = SOCK_STREAM;
	host_config.ai_flags = AI_PASSIVE;

	struct addrinfo *hosts;
	char *host = "localhost";
	char *port = "8000";
	int err_num = 0;
	if ((err_num = getaddrinfo(host, port, &host_config, &hosts) != 0)) {
		fprintf(stderr, "getaddrinfo failed: %s\n", gai_strerror(err_num));
		return -1;
	}

	int fd = 0;
	while (hosts) {
		char host_info[MEDIUM];
		   sockaddr_tostring(hosts->ai_addr, host_info);
		// fd being any value in the range (-infinity, 0] will equal false
		if ((fd = socket(hosts->ai_family, hosts->ai_socktype, hosts->ai_protocol))) {
			printf("unable to make socket for %s\n", sockaddr_tostring(hosts->ai_addr, host_info));
			strerror(errno);
			perror("socket error");
			hosts = hosts->ai_next;
			continue;
		}


		if ((connect(fd, hosts->ai_addr, hosts->ai_addrlen)) < 0) {
			char buf[LARGE];
			int ret = snprintf(buf, 
					   sizeof (char) * LARGE, 
					   "socket %i unable to connect to %s  because: \n", 
					   fd, host_info);
			handle_snprintf(ret, sizeof(char) * LARGE);
			char *buf_ptr = buf;
			printf("socket %i connect to %s failed\n", fd, buf_ptr/*ohh no buf*/);
			perror("connect error");
			hosts = hosts->ai_next;
			close(fd);
			continue;
		}

		char buf[MEDIUM];
		printf("Successfully made a connection to host %s\n", sockaddr_tostring(hosts->ai_addr, buf));
		break;
	}

	close(fd);

	return 0;
}

